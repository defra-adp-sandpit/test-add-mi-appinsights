kind: Job
apiVersion: batch/v1
metadata:
  name: monitoring-metrics-publisher
  namespace: {{ .Values.namespace }}
  labels:
    azure.workload.identity/use: "true"
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      labels:
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: {{ .Values.platformDbAdmin }}
      restartPolicy: Never
      volumes:
      - name: custom-root-ca
        secret:
          secretName: custom-ca-trust-secret
          optional: true
      containers:
      - name: monitoring-metrics-publisher
        image: ssvadpinfcr3401.azurecr.io/image/powershell-executor:491667
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 100m
            memory: 250Mi
          limits:
            cpu: 500m
            memory: 600Mi
        volumeMounts:
        - name: custom-root-ca
          readOnly: true
          mountPath: /etc/ssl/certs/defra-egress-firewall-cert-01.crt
          subPath: defra-egress-firewall-cert-01.crt
        env:
        - name: GIT_REPO_URL
          value: https://github.com/DEFRA/adp-flux-services.git
        - name: GIT_BRANCH
          value: jk/add-mi-to-group-generic
        - name: SCRIPT_FILE_NAME
          value: common/scripts/access-control/aad/Add-ManagedIdToADGroup.ps1
        - name: MI_NAME
          value: {{ .Values.serviceMIName }}
        - name: SSV_SHARED_SUBSCRIPTION_ID
          value: {{ .Values.ssvSharedSubscriptionId }}
        - name: AD_GROUP
          value: AAG-Azure-ADP-SND1-AppInsight_Monitoring-Metrics-Reader
        - name: SP_CLIENT_ID_KV
          value: {{ .Values.ssvSpnClientIdKvName }}
        - name: SP_CLIENT_SECRET_KV
          value: {{ .Values.ssvSpnClientSecretKvName }}
        - name: KEY_VAULT_NAME
          value: {{ .Values.ssvPlatformKeyvault }} 
  backoffLimit: 2
